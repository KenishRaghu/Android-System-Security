# Malware Analysis and Behavior Inspection

## 1. Target Application

**DIVA (Damn Insecure and Vulnerable App)** is the primary target for this lab. It is a deliberately vulnerable Android app (version beta) with package name `jakhar.aseem.diva`. It is used because it contains known, intentional security issues—hardcoded credentials, exported components without permission checks, insecure storage, SQL injection, and sensitive data logging—in a safe, legal context. Analyzing DIVA provides hands-on experience with the same techniques used to assess real apps and malware without the legal or ethical risks of analyzing unknown or malicious software.

## 2. Static Analysis

### Decompiling the APK with apktool

```bash
apktool d diva-beta.apk -o diva_decompiled/
```

Expected output:

```
I: Using Apktool 2.7.0 on diva-beta.apk
I: Loading resource table...
I: Decoding AndroidManifest.xml with resources...
I: Regular manifest package name: jakhar.aseem.diva
I: Decoding file-resources...
I: Decoding values */* XMLs...
I: Baksmaling classes.dex...
I: Copying assets and libs...
I: Copying unknown files...
I: Copying original files...
```

### Decompiled AndroidManifest.xml (realistic for DIVA)

Below is a representative structure of the decoded manifest showing dangerous permissions and exported components:

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="jakhar.aseem.diva"
    android:versionCode="1"
    android:versionName="1.0">
    <uses-permission android:name="android.permission.READ_CONTACTS" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.READ_CALL_LOG" />
    <application
        android:allowBackup="true"
        android:icon="@drawable/ic_launcher"
        android:label="DIVA"
        android:theme="@style/AppTheme">
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        <activity android:name=".APICredsActivity" android:exported="true" />
        <activity android:name=".HardcodeActivity" android:exported="true" />
        <activity android:name=".InputValidation2Activity" android:exported="true" />
        <activity android:name=".SQLInjectionActivity" android:exported="true" />
    </application>
</manifest>
```

### Searching for hardcoded secrets in smali

Smali is the human-readable form of Dalvik bytecode. Strings and constants used in the app (including hardcoded credentials) appear in smali files. Searching for common secret-related strings:

```bash
grep -r "password\|secret\|key\|token\|api" diva_decompiled/smali/ --include="*.smali"
```

Example (realistic) output:

```
diva_decompiled/smali/jakhar/aseem/diva/APICredsActivity.smali:    const-string v2, "admin"
diva_decompiled/smali/jakhar/aseem/diva/APICredsActivity.smali:    const-string v3, "admin123"
diva_decompiled/smali/jakhar/aseem/diva/APICredsActivity.smali:    const-string v1, "api_key_here_12345"
diva_decompiled/smali/jakhar/aseem/diva/HardcodeActivity.smali:    const-string v0, "diva"
diva_decompiled/smali/jakhar/aseem/diva/HardcodeActivity.smali:    const-string v1, "diva_secret"
```

**Interpretation**: Smali stores string constants with `const-string`. The presence of values like `admin`/`admin123`, `api_key_here_12345`, and `diva_secret` indicates hardcoded credentials and API keys. Anyone who decompiles the APK can extract these and impersonate the app or abuse backend services. In real malware, similar patterns are used for C2 passwords or stolen credentials.

## 3. Permission Analysis

Running the permission analysis script on the APK:

```bash
python3 scripts/analyze_permissions.py diva-beta.apk
```

Realistic terminal output:

```
================================================================================
PERMISSION ANALYSIS REPORT
================================================================================
APK: diva-beta.apk
Package: jakhar.aseem.diva
Total permissions: 6
--------------------------------------------------------------------------------
[!] android.permission.READ_CONTACTS (DANGEROUS)
[!] android.permission.WRITE_EXTERNAL_STORAGE (DANGEROUS)
[!] android.permission.ACCESS_FINE_LOCATION (DANGEROUS)
[!] android.permission.READ_CALL_LOG (DANGEROUS)
[+] android.permission.INTERNET (NORMAL)
[+] android.permission.ACCESS_NETWORK_STATE (NORMAL)
--------------------------------------------------------------------------------
Dangerous: 4 | Normal: 2 | Signature: 0
================================================================================
```

| Permission | Classification | Notes |
|------------|----------------|--------|
| READ_CONTACTS | Dangerous | Access to contact list; should be justified. |
| WRITE_EXTERNAL_STORAGE | Dangerous | Can write to shared storage. |
| ACCESS_FINE_LOCATION | Dangerous | Precise location; high privacy impact. |
| READ_CALL_LOG | Dangerous | Call history; sensitive. |
| INTERNET | Normal | Network access; commonly required. |
| ACCESS_NETWORK_STATE | Normal | Check connectivity; low risk. |

DIVA requests multiple dangerous permissions that are not clearly necessary for a small test app, indicating overprivilege.

## 4. Exported Component Analysis

```bash
python3 scripts/check_exported_components.py diva-beta.apk
```

Example output:

```
================================================================================
EXPORTED COMPONENTS REPORT
================================================================================
APK: diva-beta.apk
Package: jakhar.aseem.diva
--------------------------------------------------------------------------------
ACTIVITY    jakhar.aseem.diva.MainActivity              exported=True   permission=NONE        [VULNERABLE]
ACTIVITY    jakhar.aseem.diva.APICredsActivity          exported=True   permission=NONE        [VULNERABLE]
ACTIVITY    jakhar.aseem.diva.HardcodeActivity         exported=True   permission=NONE        [VULNERABLE]
ACTIVITY    jakhar.aseem.diva.InputValidation2Activity  exported=True   permission=NONE        [VULNERABLE]
ACTIVITY    jakhar.aseem.diva.SQLInjectionActivity     exported=True   permission=NONE        [VULNERABLE]
--------------------------------------------------------------------------------
Vulnerable (exported, no permission): 5
================================================================================
```

At least three exported activities with no permission (as required in the task):

- `jakhar.aseem.diva.MainActivity` — Launcher; exported by default due to MAIN/LAUNCHER.
- `jakhar.aseem.diva.APICredsActivity` — Exposes API credential UI; any app can start it.
- `jakhar.aseem.diva.HardcodeActivity` — Displays or uses hardcoded secrets; triggerable by any app.

These components are part of the app’s attack surface because they can be invoked by other apps without permission checks.

## 5. Dynamic Analysis

### Sensitive data in logcat

While using DIVA (e.g., entering credentials or opening API credentials screen):

```bash
adb logcat -s "DIVA:*" "jakhar.aseem.diva:*" "*:V" | head -50
```

Example (realistic) output:

```
--------- beginning of main
DIVA     D  Credentials entered: user=admin pass=admin123
DIVA     D  API Key loaded: api_key_here_12345
DIVA     D  Storing credential in SharedPreferences
```

This shows usernames, passwords, and API keys logged in plaintext. On a compromised device or with malware holding READ_LOGS, these could be harvested. This is a direct evidence of insecure logging.

### Network connections

```bash
adb shell "netstat -tuln 2>/dev/null || ss -tuln"
```

Example output (conceptually; exact ports may vary):

```
Active Internet connections
tcp  0  0  0.0.0.0:5555  0.0.0.0:*  LISTEN
tcp  0  0  127.0.0.1:5037  0.0.0.0:*  LISTEN
...
```

Open connections can be correlated with app behavior (e.g., INTERNET usage). For DIVA, the main concern is not C2 but the fact that any transmitted data (if not over HTTPS) could be intercepted; combined with logged credentials, risk increases.

### Observed behaviors

- **Insecure logging**: Sensitive strings (username, password, API key) passed to `Log.d()` and visible in logcat.
- **Credential storage**: Credentials and keys stored in SharedPreferences or files without encryption; confirmed via decompilation and run-as inspection of app data.
- **Unprotected file writes**: Some outputs written to app-private or shared storage in plaintext, readable by root or backup.

## 6. Suspicious System Interactions Found

| Behavior | Severity | Location in App | Impact |
|----------|----------|-----------------|--------|
| Hardcoded credentials in smali | High | APICredsActivity, HardcodeActivity | Theft of credentials/API keys via decompilation; abuse of backend or user accounts. |
| Exported activities without permission | High | MainActivity, APICredsActivity, HardcodeActivity, InputValidation2Activity, SQLInjectionActivity | Any app can launch these screens, trigger logic, or abuse UI that handles sensitive data. |
| Sensitive data in logcat | High | Login and API credential flows | Credential theft via log access (malware, rooted device, or debugging). |
| Overprivileged permissions | Medium | Manifest | Unnecessary access to contacts, location, call log; larger impact if app is compromised. |
| Credentials in SharedPreferences | Medium | Multiple activities | Theft via backup, root, or device access. |
| Unencrypted or unvalidated network use | Medium | Any network code | Eavesdropping or MITM if TLS is not enforced or certificates not validated. |

## 7. Summary of Malware Indicators

DIVA is not malware; it is an intentional training app. The same behaviors, however, would support classifying a real app as malicious or high-risk:

- **Excessive permissions**: Requesting contacts, call log, location, or SMS without a legitimate need is common in spyware and data stealers.
- **Exported components with no protection**: Malware often uses exported components to receive commands or exfiltrate data from other apps; here we see the same misconfiguration.
- **Hardcoded secrets and C2**: Hardcoded URLs, API keys, or passwords in smali are typical of malware; in DIVA they illustrate the same static-analysis finding.
- **Sensitive data in logs**: Real malware sometimes logs stolen data or C2 responses; here the app logs its own credentials, which is a vulnerability rather than malicious intent but uses the same dangerous pattern.
- **Insecure storage**: Storing credentials or tokens in plaintext is a hallmark of poorly secured apps and is also used by malware to cache stolen data before exfiltration.

Documenting these patterns in DIVA provides a clear mapping from “vulnerable app” to “indicators that would be treated as malicious or high risk in a real assessment.”
